# HW10 - Разворачиваем и настраиваем БД с большими данными

>_Необходимо провести сравнение скорости работы
запросов на различных СУБД:_
> - Выбрать одну из СУБД
> - Загрузить в неё данные (от 10 до 100 Гб)
> - Сравнить скорость выполнения запросов на PosgreSQL и выбранной СУБД
> - Описать что и как делали и с какими проблемами столкнулись

> В качестве СУБД выбрала MS SQL Server 2022 Evaluation edition. Как и PostgreSQL, выбранная СУБД является также реляционной. 
> При выполнении задания использовала две VMs с одинаковыми ресурсами: 4cpu / 8GB memory / 50GB SSD / ОС ubuntu 20.04.

![VMs](/images/10_00.JPG)

## 1. VM с PostgreSQL 16 и БД размером 10 GB
### 1.1. Создала VM: pg-vm 4cpu 8GB memory 50GB SSD диск ubuntu 20.04

### 1.2. Установила Postgres:

```
sudo apt update && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql
```

> _Проверила:_

```
pg_lsclusters
```

![PostgreSQL](/images/10_01.JPG)

### 1.3. Для заполнения БД данными выбрала dataset "Crowdsourced air traffic data from The OpenSky Network 2020", загрузила в формате csv.gz

```
wget -r -A"flightlist_20*.csv.gz" https://zenodo.org/records/5092942
```

>_Список загруженных файлов:_

![PostgreSQL download](/images/10_02.JPG)

### 1.4. Создала папку для хранения разархивированных файлов

```
sudo mkdir /usr/temp/
sudo chown -R elr:elr /usr/temp/
```
### 1.5. Разархивировала и сохранила файлы в папку /usr/temp/

```
for f in *.gz ; do gunzip -c "$f" > /usr/temp/"${f%.*}" ; done
```
![gunzip](/images/10_03.JPG)

![files list gunzip](/images/10_04.JPG)

### 1.6. Подключилась к PostgreSQL и создала БД с таблицей для импорта

```
sudo -u postgres psql -p 5432

CREATE DATABASE testdb;
\c testdb;

CREATE TABLE opensky
(
    callsign text NULL,
    number varchar(100) NULL,
    icao24 varchar(500) NULL,
    registration varchar(100) NULL,
    typecode varchar(100) NULL,
    origin varchar(100) NULL,
    destination varchar(100) NULL,
    firstseen TIMESTAMP WITH TIME ZONE NULL,
    lastseen TIMESTAMP WITH TIME ZONE NULL,
    day TIMESTAMP WITH TIME ZONE NULL,
    latitude_1 decimal(28,15) NULL,
    longitude_1 decimal(28,15) NULL,
    altitude_1 decimal(28,15) NULL,
    latitude_2 decimal(28,15) NULL,
    longitude_2 decimal(28,15) NULL,
    altitude_2 decimal(28,2) NULL
);

```
![Create PG DB/Table](/images/10_05.JPG)

### 1.7. Конфигурирование PostgreSQL

> Для выбора оптимальных настроек использовала сайт-конфигуратор https://www.pgconfig.org/.

![PostgreSQL configuring](/images/10_06.JPG)

>__Рекомендованные значения:__

```
# Generated by PGConfig 3.1.4 (1fe6d98dedcaad1d0a114617cfd08b4fed1d8a01)
# https://api.pgconfig.org/v1/tuning/get-config?format=conf&include_pgbadger=true&log_format=csvlog&max_connections=100&pg_version=16&environment_name=DW&total_ram=8GB&cpus=4&drive_type=SSD&arch=x86-64&os_type=linux

# Memory Configuration
shared_buffers = 2GB
effective_cache_size = 6GB
work_mem = 41MB
maintenance_work_mem = 410MB

# Checkpoint Related Configuration
min_wal_size = 2GB
max_wal_size = 3GB
checkpoint_completion_target = 0.9
wal_buffers = -1

# Network Related Configuration
listen_addresses = '*'
max_connections = 100

# Storage Configuration
random_page_cost = 1.1
effective_io_concurrency = 200

# Worker Processes Configuration
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_workers = 2

# Logging configuration for pgbadger
logging_collector = on
log_checkpoints = on
log_connections = on
log_disconnections = on
log_lock_waits = on
log_temp_files = 0
lc_messages = 'C'

# Adjust the minimum time to collect the data
log_min_duration_statement = '10s'
log_autovacuum_min_duration = 0

# CSV Configuration
log_destination = 'csvlog'
```
> Применила некоторые из рекомендованных значений:

```
sudo -u postgres psql

-- Memory Configuration
ALTER SYSTEM SET shared_buffers TO '2GB';
ALTER SYSTEM SET effective_cache_size TO '6GB';
ALTER SYSTEM SET work_mem TO '41MB';
ALTER SYSTEM SET maintenance_work_mem TO '410MB';

sudo pg_ctlcluster 16 main stop
sudo pg_ctlcluster 16 main start
sudo pg_ctlcluster 16 main status

SHOW shared_buffers;
SHOW effective_cache_size;
SHOW work_mem;
SHOW maintenance_work_mem;

```
![PG Configuration](/images/10_07.JPG)

### 1.8. Подготовила скрипты для импорта данных из csv файлов в таблицу, импортировала данные

```
sudo chown -R postgres:postgres /usr/temp/

copy opensky FROM '/usr/temp/flightlist_20190101_20190131.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20191101_20191130.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200901_20200930.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190201_20190228.csv' DELIMITER ',' CSV HEADER;  
copy opensky FROM '/usr/temp/flightlist_20191201_20191231.csv' DELIMITER ',' CSV HEADER;  
copy opensky FROM '/usr/temp/flightlist_20201001_20201031.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190301_20190331.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200101_20200131.csv' DELIMITER ',' CSV HEADER;  
copy opensky FROM '/usr/temp/flightlist_20201101_20201130.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190401_20190430.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200201_20200229.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20201201_20201231.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190501_20190531.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200301_20200331.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20210101_20210131.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190601_20190630.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200401_20200430.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20210201_20210228.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190701_20190731.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200501_20200531.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20210301_20210331.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190801_20190831.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200601_20200630.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20210401_20210430.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20190901_20190930.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200701_20200731.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20210501_20210530.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20191001_20191031.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20200801_20200831.csv' DELIMITER ',' CSV HEADER; 
copy opensky FROM '/usr/temp/flightlist_20210601_20210630.csv' DELIMITER ',' CSV HEADER; 
```
> Один из примеров:

![Import data file](/images/10_08.JPG)

> Проверим кол- во строк в таблице и размер:

```
SELECT COUNT(*) FROM opensky;
SELECT pg_size_pretty(pg_database_size('testdb')) AS size;
```

![Import data file](/images/10_09.JPG)

## 2. VM с MS SQL Server 2022 и БД размером 10 GB
### 2.1. Создала VM: sql-vm 4cpu 8GB memory 50GB SSD диск ubuntu 20.04

### 2.2. Установила MS SQL Server 2022:

#### 2.2.1. Import the public repository GPG keys:

```
curl https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
```

#### 2.2.2. Import the public repository GPG keys:Register the SQL Server Ubuntu repository:

```
sudo add-apt-repository "$(wget -qO- https://packages.microsoft.com/config/ubuntu/20.04/mssql-server-2022.list)"
```

#### 2.2.3. Run the following commands to install SQL Server:

```
sudo apt-get update
sudo apt-get install -y mssql-server
```

#### 2.2.4. Run mssql-conf setup

```
sudo /opt/mssql/bin/mssql-conf setup
```
![Install MS SQL Server](/images/10_10.JPG)

#### 2.2.5. Verify that the service is running:

```
systemctl status mssql-server --no-pager
```
![MS SQL Server status](/images/10_11.JPG)

### 2.3 Install the SQL Server command-line tools

#### 2.3.1. For Ubuntu 20.04, use the following command:

```
curl https://packages.microsoft.com/config/ubuntu/20.04/prod.list | sudo tee /etc/apt/sources.list.d/mssql-release.list
```

#### 2.3.2. Update the sources list and run the installation command with the unixODBC developer package.

```
sudo apt-get update
sudo apt-get install mssql-tools18 unixodbc-dev
```

> To update to the latest version of mssql-tools, run the following commands:

```
sudo apt-get update  
sudo apt-get install mssql-tools18
```

### 2.4. Подключилась локально к MS SQL Server:

```
/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P 'password' -No
```
![sqlcmd](/images/10_12.JPG)

### 2.5. Создала БД и таблицу

```
CREATE DATABASE testdb;
go
use testdb;
go
CREATE TABLE dbo.opensky (callsign varchar(200) NULL,number varchar(100) NULL,icao24 varchar(500) NULL,registration varchar(100) NULL,typecode varchar(100) NULL,origin varchar(100) NULL,destination varchar(100) NULL,firstseen datetime2(7) NULL,lastseen datetime2(7) NULL,day datetime2(7) NULL,latitude_1 varchar(100) NULL,longitude_1 varchar(100) NULL,altitude_1 varchar(100) NULL,latitude_2 varchar(100) NULL,longitude_2 varchar(100) NULL,altitude_2 varchar(100) NULL);
go
--проверила существование таблицы
SELECT * FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE='BASE TABLE';
go

```
![sqlcmd create database/table](/images/10_13.JPG)

### 2.6. Импорт данных в MS SQL Server 2022

#### 2.6.1. Для заполнения БД данными выбрала тот же dataset "Crowdsourced air traffic data from The OpenSky Network 2020", что и для PostgreSQL, загрузила в формате csv.gz

```
wget -r -A"flightlist_20*.csv.gz" https://zenodo.org/records/5092942
```

>_Список загруженных файлов:_

![MS SQL Server download](/images/10_14.JPG)

#### 2.6.2. Создала папку для хранения разархивированных файлов

```
sudo mkdir /usr/temp/
sudo chown -R elr:elr /usr/temp/
```
#### 2.6.3. Разархивировала и сохранила файлы в папку /usr/temp/

```
for f in *.gz ; do gunzip -c "$f" > /usr/temp/"${f%.*}" ; done
```
![MS SQL Server gunzip](/images/10_15.JPG)

![MS SQL Server files list gunzip](/images/10_16.JPG)

#### 2.6.4. Подготовила скрипты для импорта данных из csv файлов в таблицу, импортировала данные

```
use testdb;
go

BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190101_20190131.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190601_20190630.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20191101_20191130.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200401_20200430.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200901_20200930.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20210201_20210228.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190201_20190228.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190701_20190731.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20191201_20191231.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ','); 
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200501_20200531.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ','); 
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20201001_20201031.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20210301_20210331.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190301_20190331.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190801_20190831.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200101_20200131.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200601_20200630.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20201101_20201130.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20210401_20210430.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190401_20190430.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190901_20190930.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200201_20200229.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200701_20200731.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20201201_20201231.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20210501_20210530.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20190501_20190531.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20191001_20191031.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200301_20200331.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20200801_20200831.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20210101_20210131.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');  
BULK INSERT dbo.opensky FROM '/usr/temp/flightlist_20210601_20210630.csv' WITH (DATAFILETYPE = 'char',FIRSTROW = 2,FIELDTERMINATOR = ',');

go
```

![MS SQL Server bulk insert](/images/10_17.JPG)

#### 2.6.5. Проверила кол-во строк и размер

```
use testdb;
go
SELECT COUNT(*) FROM dbo.opensky;
go
exec sp_spaceused 'opensky'
go
```

![MS SQL Server total](/images/10_18.JPG)

## 3. Тестирование

> Для целей тестирования использовала два запроса на выборку данных (SELECT), так как при работе с большими данными рассматриваем БД как хранилище DWH. Сначала выполнила запросы в обеих СУБД без индексов, а потом те же запросы после создания индексов и сравнила их по времени выполнения.

> Взглянем на обе БД (кол-во строк и размеры БД):

![MS SQL Server](/images/10_18.JPG)

![PosgreSQL](/images/10_09.JPG)

### 3.1. Запустила выполнение запросов (без индексов)

#### 3.1.1. SELECT COUNT(*) FROM opensky WHERE callsign IN ('UUEE', 'UUDD', 'UUWW');

> PostgreSQL:

![PosgreSQL q1](/images/10_19.JPG)

> MS SQL Server:

![MS SQL Server q1](/images/10_21.JPG)


#### 3.1.2. SELECT origin, COUNT(*) FROM opensky GROUP BY origin ORDER BY origin ASC;

> PostgreSQL:

![PosgreSQL q2](/images/10_20.JPG)

> MS SQL Server:

![MS SQL Server q2](/images/10_210.JPG)

#### 3.2. Создала индексы

```
--PG
CREATE INDEX ix_opensky ON opensky (callsign, origin);

--MS SQL Server
CREATE INDEX ix_opensky ON dbo.opensky (callsign, origin);

```

> PostgreSQL:

![PostgeSQL index creation](/images/10_23.JPG)

> MS SQL Server:

![MS SQL Server index creation](/images/10_24.JPG)

### 3.3. Запустила выполнение запросов (после создания индексов)

#### 3.3.1. SELECT COUNT(*) FROM opensky WHERE callsign IN ('UUEE', 'UUDD', 'UUWW');

> PostgreSQL:

![PosgreSQL index q1](/images/10_25.JPG)

> MS SQL Server:

![MS SQL Server index q1](/images/10_28.JPG)

#### 3.3.2. SELECT origin, COUNT(*) FROM opensky GROUP BY origin ORDER BY origin ASC;

> PostgreSQL:

![PosgreSQL index q2 rows](/images/10_26.JPG)

![PosgreSQL index q2](/images/10_27.JPG)

> MS SQL Server:

![MS SQL Server index q2](/images/10_29.JPG)

> __Сравнение результатов:__

> До создания индекса оба запроса выполнились быстрее в PostgreSQL, но после создания индекса запросы быстрее выполнились в MS SQL Server. Индекс дольше создавался в MS SQL Server.

![Summary](/images/10_30.JPG)





